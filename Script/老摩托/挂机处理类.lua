-- -- -- @Author: baidwwy
-- -- -- @Date:   2024-01-16 14:59:56
-- -- -- @Last Modified by:   baidwwy
-- -- -- @Last Modified time: 2025-08-15 16:42:30

-- local 挂机处理类 = class()

-- function 挂机处理类:初始化()
-- end

-- function 挂机处理类:更新(dt)
-- end

-- function 挂机处理类:补充挂机(id)
--   local 需求道具="挂机凭证"
--    if not 玩家数据[id].道具:判定背包道具(id,需求道具,1) then
--     常规提示(id,"#Y/你的"..需求道具.."不足1个,无法补充挂机次数!")
--     return
--    end
--   玩家数据[id].道具:消耗背包道具(玩家数据[id].连接id,id,需求道具,1)
--   玩家数据[id].角色.数据.挂机系统.次数=玩家数据[id].角色.数据.挂机系统.次数+50
--   常规提示(id,"#Y/补充成功,剩余可用次数为:#G/"..玩家数据[id].角色.数据.挂机系统.次数)
--   self:索要挂机(id)
-- end

-- function 挂机处理类:取战斗次数(类型)

--   if 类型 == 100053 then  --经验宝宝
--       return 10
--    elseif 类型 == 100051 then  --天降灵猴
--       return 50
--    elseif 类型 == 100122 then  --捣乱年兽
--       return 50
--    elseif 类型 == 100033 then  --糖果派对
--       return 10
--    elseif 类型 == 100060 then  --四墓灵鼠
--       return 10
--    elseif 类型 == 110022 then  --财神爷
--       return 10
--    elseif 类型 == 100038 then  --知了先锋
--       return 100
--    elseif 类型 == 100027 then  --知了王
--       return 50
--    elseif 类型 == 110041 then  --十二生肖
--       return 10
--    elseif 类型 == 110021 then  --新冠病毒
--       return 40
--    elseif 类型 == 110016 then  --影青龙
--       return 5
--    elseif 类型 == 110017 then  --影朱雀
--       return 5
--    elseif 类型 == 110018 then  --影白虎
--       return 5
--    elseif 类型 == 110019 then  --影玄武
--       return 5
--    elseif 类型 == 110020 then  --影麒麟
--       return 5
--    elseif 类型 == 110045 then  --万象福
--       return 10
--    elseif 类型 == 100123 then  --年兽王
--       return 10
--    elseif 类型 == 100085 then  --倔强青铜
--       return 5
--    elseif 类型 == 100086 then  --秩序白银
--       return 5
--    elseif 类型 == 100087 then  --荣耀黄金
--       return 5
--    elseif 类型 == 100088 then  --永恒钻石
--       return 5
--    elseif 类型 == 100089 then  --至尊星耀
--       return 5
--    elseif 类型 == 100090 then  --最强王者
--       return 5
--    elseif 类型 == 110042 then  --桐人
--       return 10
--    elseif 类型 == 110043 then  --魔化桐人
--       return 10
--    elseif 类型 == 110046 then  --新春快乐
--       return 50
--    elseif 类型 == 110047 then  --小小盲僧
--       return 20
--   end

--   return  50

-- end


-- function 挂机处理类:持续挂机(id)
--   local v =  玩家数据[id].角色.数据.挂机系统
--  -- print("111")
--   if v.胜利时间 == nil or  v.胜利时间 == 0 then return end

--  -- print(v.开启,玩家数据[id].战斗,v.胜利时间)
--   if v.开启 and 玩家数据[id].战斗 == 0 and  v.胜利时间 + 取随机数(3,10) < os.time()  then

--       发送数据(玩家数据[id].连接id,199.99,玩家数据[id].角色.数据.挂机系统)
--       if v.次数 < 1 then
--         玩家数据[id].角色.数据.挂机系统.开启=false
--         常规提示(id,"#Y/您没有可用挂机次数了,请及时补充")
--         self:移除挂机(id)
--         return
--       end
--       v.次数 = v.次数 - 1
--       print(self:取战斗次数(v.战斗类型), v.战斗次数[v.战斗类型])
--        local 可战斗次数 = self:取战斗次数(v.战斗类型)
--        local 已战斗次数 = v.战斗次数[v.战斗类型] or 0

--       if 可战斗次数 <= 已战斗次数 then
--           常规提示(id,"#Y/您当前目标挂机次数已达上限")
--           v.次数 = v.次数 + 1
--           return
--       end
--       -- if self:取战斗次数(v.战斗类型) <= v.战斗次数[v.战斗类型] then
--       --   常规提示(id,"#Y/您今天次数上限了")
--       --   return
--       -- end


--       战斗准备类:创建战斗(id+0,v.战斗类型)
--       v.战斗次数[v.战斗类型] =  (v.战斗次数[v.战斗类型] or 0) + 1
--   end

-- end

-- --可额外设立新条件
-- --会员卡等要求
-- function 挂机处理类:移除挂机(id)


--   for i = 1, #挂机数据 do

--     if 挂机数据[i] == id then

--       table.remove(挂机数据,i)
--       玩家数据[id].角色.数据.挂机系统.开启=false
--       break
--     end

--   end


-- end

-- function 挂机处理类:添加挂机(id)
--   table.insert(挂机数据,id)
--   玩家数据[id].角色.数据.挂机系统.开启=true

-- end
-- local 战斗类型 = {100053,100051,100122,100033,100060,110022,100038,100027,110041,110021,110016,110017,110018,110019,110020
-- ,110045,100123,100085,100086,100087,100088,100089,100090,110042,110043,110046,110047,100033,100033,100033}
-- function 挂机处理类:开始挂机(id,目标)
--  if 目标==nil then
--   常规提示(id,"#Y/目标数据有误！")
--   return
--  elseif 玩家数据[id].队伍==0 or 取队长权限(id)==false then
--   常规提示(id,"#Y/必须组队才能开启挂机")
--   return
--  elseif 玩家数据[id].角色.数据.挂机系统==nil or 玩家数据[id].角色.数据.挂机系统.次数<1 then
--   常规提示(id,"#Y/您没有可用挂机次数了,请及时补充")
--   return
--  end
--  if  玩家数据[id].角色.数据.挂机系统.战斗次数 == nil then
--       玩家数据[id].角色.数据.挂机系统.战斗次数 ={[100053]=0,[100051]=0,[100122]=0,[100033]=0,[100060]=0,[110022]=0,[100038]=0
--     ,[100027]=0,[110041]=0,[110021]=0,[110016]=0,[110017]=0,[110018]=0,[110019]=0,[110020]=0,[110045]=0,[100123]=0,[100085]=0
--     ,[100086]=0,[100087]=0,[100088]=0,[100089]=0,[100090]=0,[110042]=0,[110043]=0,[110046]=0,[110047]=0,[100033]=0,[100033]=0}
--   end
-- if  玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标]] == nil then
--   玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标]]=0
-- end

--       local 可战斗次数 = self:取战斗次数(战斗类型[目标])
--       local 已战斗次数 =  玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标]] or 0

--       if 可战斗次数 <= 已战斗次数 then
--           常规提示(id,"#Y/您当前目标今日挂机次数已达上限")
--           return
--       end

--   -- if self:取战斗次数(战斗类型[目标]) <= 玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标]] then
--   --   常规提示(id,"#Y/您今天次数上限了")
--   --   return
--   -- end
--  self:添加挂机(id)
--  玩家数据[id].角色.数据.挂机系统.战斗类型 = 战斗类型[目标]+ 0
--  战斗准备类:创建战斗(id+0,战斗类型[目标]+ 0)

--  玩家数据[id].角色.数据.挂机系统.次数=玩家数据[id].角色.数据.挂机系统.次数-1
--  玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标]] = 玩家数据[id].角色.数据.挂机系统.战斗次数[战斗类型[目标] or 0]+1

-- end

-- function 挂机处理类:索要挂机(id)
--   if 玩家数据[id].角色.数据.挂机系统 == nil then
--     发送数据(玩家数据[id].连接id, 7, "#Y/你还未开通挂机功能。")
--   else
--     发送数据(玩家数据[id].连接id,199.99,玩家数据[id].角色.数据.挂机系统)
--   end
-- end

-- return 挂机处理类
-- -- @Author: baidwwy
-- -- @Date:   2024-01-16 14:59:56
-- -- @Last Modified by:   baidwwy
-- -- @Last Modified time: 2025-07-08 21:01:43

local 挂机处理类 = class()

-- 定义每日可战斗次数的上限值配置（移除多余字符）
挂机处理类.可战斗次数上限 = {
    [100053] = 5,  --经验宝宝
    [100051] = 50,  --天降灵猴
    [100122] = 10,  --捣乱年兽
    [100033] = 10,  --糖果派对
    [100060] = 10,  --四墓灵鼠
    [110022] = 10,  --财神爷
    [100038] = 100,  --知了先锋
    [100027] = 50,  --知了王
    [110041] = 10,  --十二生肖
    [110021] = 40,  --新冠病毒
    [110016] = 20,   --影青龙
    [110017] = 20,   --影朱雀
    [110018] = 20,   --影白虎
    [110019] = 20,   --影玄武
    [110020] = 20,   --影麒麟
    [110045] = 10,  --万象福
    [100123] = 10,  --年兽王
    [100085] = 50,   --倔强青铜
    [100086] = 50,   --秩序白银
    [100087] = 50,   --荣耀黄金
    [100088] = 50,   --永恒钻石
    [100089] = 50,   --至尊星耀
    [100090] = 50,   --最强王者
    [110042] = 10,  --桐人
    [110043] = 10,  --魔化桐人
    [110046] = 50,  --新春快乐
    [110047] = 10,  --小小盲僧
    default = 99999    --默认值
}

function 挂机处理类:初始化()
end

function 挂机处理类:更新(dt)
end

function 挂机处理类:补充挂机(id)
    local 月卡有效 = false
    if 玩家数据[id].角色.数据.月卡 and 玩家数据[id].角色.数据.月卡.开通 and os.time() < 玩家数据[id].角色.数据.月卡.到期时间 then
        月卡有效 = true
    end

    if 月卡有效 then
        常规提示(id, "#Y/您已开通自动挂机月卡，无法手动补充挂机次数！")
        return
    end

    -- local 需求道具 = "挂机凭证"
    -- if not 玩家数据[id].道具:判定背包道具(id, 需求道具, 1) then
    --     常规提示(id, "#Y/你的"..需求道具.."不足1个,无法补充挂机次数!")
    --     return
    -- end

    -- 玩家数据[id].道具:消耗背包道具(玩家数据[id].连接id, id, 需求道具, 1)
    -- 玩家数据[id].角色.数据.挂机系统.次数 = 玩家数据[id].角色.数据.挂机系统.次数 + 50
    -- 常规提示(id, "#Y/补充成功,剩余可用次数为:#G/"..玩家数据[id].角色.数据.挂机系统.次数)
    self:索要挂机(id)
end

function 挂机处理类:取战斗次数上限(类型)
    return self.可战斗次数上限[类型] or self.可战斗次数上限.default
end

function 挂机处理类:初始化玩家挂机系统(id)
    local v = 玩家数据[id].角色.数据.挂机系统
    if v.今日可战斗次数 == nil then
        v.今日可战斗次数 = {}
    end

    -- 初始化所有类型为0（修正变量名）
    for 类型, _ in pairs(self.可战斗次数上限) do
        if 类型 ~= "default" then
            v.今日可战斗次数[类型] = v.今日可战斗次数[类型] or 0
        end
    end
end

-- 检查队伍成员是否达到战斗次数上限
function 挂机处理类:队伍可进行该类型战斗(队伍ID, 类型)
    if not 队伍数据[队伍ID] or not 队伍数据[队伍ID].成员数据 then
        return false
    end

    local 成员组 = 队伍数据[队伍ID].成员数据
    local 上限 = self:取战斗次数上限(类型)

    for _, 成员ID in ipairs(成员组) do
        if 玩家数据[成员ID] and 玩家数据[成员ID].角色.数据.挂机系统 then
            self:初始化玩家挂机系统(成员ID)  -- 确保每个成员都有初始化数据
            local 成员今日次数 = 玩家数据[成员ID].角色.数据.挂机系统.今日可战斗次数[类型] or 0

            if 成员今日次数 >= 上限 then
                return false
            end
        end
    end

    return true
end

-- 检查队伍中所有成员是否都开通了月卡，如果有未开通的成员则返回其ID
function 挂机处理类:检查队伍成员月卡状态(队伍ID)
    if not 队伍数据[队伍ID] or not 队伍数据[队伍ID].成员数据 then
        return nil, "队伍数据异常"
    end

    local 成员组 = 队伍数据[队伍ID].成员数据

    for _, 成员ID in ipairs(成员组) do
        if 玩家数据[成员ID] and 玩家数据[成员ID].角色.数据.月卡 then
            local 月卡有效 = false
            if 玩家数据[成员ID].角色.数据.月卡.开通 and os.time() < 玩家数据[成员ID].角色.数据.月卡.到期时间 then
                月卡有效 = true
            end

            if not 月卡有效 then
                return 成员ID, "成员"..成员ID.."的会员未开通或已过期，五个会员才能触发挂机"
            end
        else
            -- 如果成员没有月卡数据，则认为未开通
            return 成员ID, "成员"..成员ID.."未开通月卡"
        end
    end

    return nil, "所有成员月卡均已开通"
end

function 挂机处理类:持续挂机(id)
    local v = 玩家数据[id].角色.数据.挂机系统
    if v.胜利时间 == nil or v.胜利时间 == 0 then return end

    local 月卡有效 = false
    if 玩家数据[id].角色.数据.月卡 and 玩家数据[id].角色.数据.月卡.开通 and os.time() < 玩家数据[id].角色.数据.月卡.到期时间 then
        月卡有效 = true
    end

    if v.开启 and 玩家数据[id].战斗 == 0 and v.胜利时间 + 取随机数(3,10) < os.time() then
        发送数据(玩家数据[id].连接id, 199.99, v)

        if not 月卡有效 then
            if v.次数 < 1 then
                玩家数据[id].角色.数据.挂机系统.开启 = false
                常规提示(id, "#Y/五开会员才能挂机,请及时联系GM")
                self:移除挂机(id)
                return
            end
        end

        self:初始化玩家挂机系统(id)
        local 类型 = v.战斗类型
        local 队伍ID = 玩家数据[id].队伍
        local 上限 = self:取战斗次数上限(类型)

        -- 检查队伍中所有成员是否达到上限
        if not self:队伍可进行该类型战斗(队伍ID, 类型) then
            常规提示(id, "#Y/队伍中有成员已达到该目标的战斗次数上限")
            玩家数据[id].角色.数据.挂机系统.开启 = false
            self:移除挂机(id)
            return
        end

        if not 月卡有效 then
            v.次数 = v.次数 - 1
        end

        -- 为所有成员增加战斗次数
        for _, 成员ID in ipairs(队伍数据[队伍ID].成员数据) do
            if 玩家数据[成员ID] and 玩家数据[成员ID].角色.数据.挂机系统 then
                local 成员挂机系统 = 玩家数据[成员ID].角色.数据.挂机系统
                -- 记录今日战斗次数
                成员挂机系统.今日可战斗次数[类型] = (成员挂机系统.今日可战斗次数[类型] or 0) + 1
                -- 记录总战斗次数（修正变量名）
                if not 成员挂机系统.战斗次数 then
                    成员挂机系统.战斗次数 = {}
                end
                成员挂机系统.战斗次数[类型] = (成员挂机系统.战斗次数[类型] or 0) + 1
            end
        end

        v.胜利时间 = 0
        战斗准备类:创建战斗(id, 类型)
    end
end

function 挂机处理类:移除挂机(id)
    for i = 1, #挂机数据 do
        if 挂机数据[i] == id then
            table.remove(挂机数据, i)
            玩家数据[id].角色.数据.挂机系统.开启 = false
            break
        end
    end
end

function 挂机处理类:添加挂机(id)
    table.insert(挂机数据, id)
    玩家数据[id].角色.数据.挂机系统.开启 = true
end

local 战斗类型 = {
    100053, 100051, 100122, 100033, 100060, 110022, 100038, 100027,
    110041, 110021, 110016, 110017, 110018, 110019, 110020, 110045,
    100123, 100085, 100086, 100087, 100088, 100089, 100090, 110042,
    110043, 110046, 110047, 100033, 100033, 100033
}

function 挂机处理类:开始挂机(id, 目标)
    if 目标 == nil then
        常规提示(id, "#Y/目标数据有误！")
        return
    elseif 玩家数据[id].队伍 == 0 or 取队长权限(id) == false then
        常规提示(id, "#Y/必须组队才能开启挂机")
        return
    elseif 玩家数据[id].角色.数据.挂机系统 == nil then
        常规提示(id, "#Y/挂机系统未初始化")
        return
    end

    local 月卡有效 = false
    if 玩家数据[id].角色.数据.月卡 and 玩家数据[id].角色.数据.月卡.开通 and os.time() < 玩家数据[id].角色.数据.月卡.到期时间 then
        月卡有效 = true
    end
    if not 月卡有效 then
        if 玩家数据[id].角色.数据.挂机系统.次数 < 1 then
            常规提示(id, "#Y/只有五开会员才可以挂机,请联系GM")
            return
        end
    end

    local v = 玩家数据[id].角色.数据.挂机系统
    local 目标类型 = 战斗类型[目标]
    local 队伍ID = 玩家数据[id].队伍

    -- 确保队伍数据存在
    if not 队伍数据[队伍ID] or not 队伍数据[队伍ID].成员数据 then
        常规提示(id, "#Y/队伍数据异常")
        return
    end

    -- 检查队伍中所有成员是否都开通了月卡
    local 未开通成员ID, 提示信息 = self:检查队伍成员月卡状态(队伍ID)
    if 未开通成员ID then
        常规提示(id, "#Y/"..提示信息.."，无法开启挂机！")
        return
    end

    -- 初始化队伍成员挂机系统
    for _, 成员ID in ipairs(队伍数据[队伍ID].成员数据) do
        if 玩家数据[成员ID] and 玩家数据[成员ID].角色.数据.挂机系统 then
            self:初始化玩家挂机系统(成员ID)
        end
    end

    -- 检查队伍中所有成员是否达到上限（修正变量名）
    if not self:队伍可进行该类型战斗(队伍ID, 目标类型) then
        常规提示(id, "#Y/队伍中有成员已达到该目标的战斗次数上限")
        return
    end

    -- 创建战斗次数记录如果不存在
    if v.战斗次数 == nil then
        v.战斗次数 = {
            [100053]=0, [100051]=0, [100122]=0, [100033]=0, [100060]=0, [110022]=0,
            [100038]=0, [100027]=0, [110041]=0, [110021]=0, [110016]=0, [110017]=0,
            [110018]=0, [110019]=0, [110020]=0, [110045]=0, [100123]=0, [100085]=0,
            [100086]=0, [100087]=0, [100088]=0, [100089]=0, [100090]=0, [110042]=0,
            [110043]=0, [110046]=0, [110047]=0
        }
    end

    if v.战斗次数[目标类型] == nil then
        v.战斗次数[目标类型] = 0
    end

    -- 扣除挂机次数（非月卡）
    if not 月卡有效 then
        v.次数 = v.次数 - 1
    end

    -- 为所有成员增加战斗次数
    for _, 成员ID in ipairs(队伍数据[队伍ID].成员数据) do
        if 玩家数据[成员ID] and 玩家数据[成员ID].角色.数据.挂机系统 then
            local 成员挂机系统 = 玩家数据[成员ID].角色.数据.挂机系统
            -- 记录今日战斗次数
            成员挂机系统.今日可战斗次数[目标类型] = (成员挂机系统.今日可战斗次数[目标类型] or 0) + 1
            -- 记录总战斗次数
            if not 成员挂机系统.战斗次数 then
                成员挂机系统.战斗次数 = {}
            end
            成员挂机系统.战斗次数[目标类型] = (成员挂机系统.战斗次数[目标类型] or 0) + 1
        end
    end

    v.战斗类型 = 目标类型
    self:添加挂机(id)
    v.胜利时间 = 0
    战斗准备类:创建战斗(id, 目标类型)
end

function 挂机处理类:索要挂机(id)
    if 玩家数据[id].角色.数据.挂机系统 == nil then
        发送数据(玩家数据[id].连接id, 7, "#Y/你还未开通挂机功能。")
    else
        local 挂机系统数据 = 玩家数据[id].角色.数据.挂机系统
        挂机系统数据.月卡开通 = false

        -- 初始化今日可战斗次数数据
        self:初始化玩家挂机系统(id)

        -- 添加今日可战斗次数上限信息
        挂机系统数据.今日可战斗次数上限 = {}
        for 类型, 上限 in pairs(self.可战斗次数上限) do
            if 类型 ~= "default" then
                挂机系统数据.今日可战斗次数上限[类型] = 上限
            end
        end

        if 玩家数据[id].角色.数据.月卡 then
            挂机系统数据.月卡开通 = 玩家数据[id].角色.数据.月卡.开通
            if 玩家数据[id].角色.数据.月卡.开通 and os.time() < 玩家数据[id].角色.数据.月卡.到期时间 then
                挂机系统数据.月卡到期时间 = 玩家数据[id].角色.数据.月卡.到期时间
            elseif 玩家数据[id].角色.数据.月卡.开通 then
                玩家数据[id].角色.数据.月卡.开通 = false
                挂机系统数据.月卡开通 = false
            end
        end

        发送数据(玩家数据[id].连接id, 199.99, 挂机系统数据)
    end
end

-- 添加每日重置函数
function 挂机处理类:每日重置玩家挂机数据(所有玩家数据)
    for id, 玩家 in pairs(所有玩家数据) do
        if 玩家.角色.数据.挂机系统 then
            玩家.角色.数据.挂机系统.今日可战斗次数 = {}
            玩家.角色.数据.挂机系统.今日可战斗次数上限 = {}

            -- 初始化今日可战斗次数为0并记录上限
            for 类型, 上限 in pairs(self.可战斗次数上限) do
                if 类型 ~= "default" then
                    玩家.角色.数据.挂机系统.今日可战斗次数[类型] = 0
                    玩家.角色.数据.挂机系统.今日可战斗次数上限[类型] = 上限
                end
            end
        end
    end
end

return 挂机处理类



