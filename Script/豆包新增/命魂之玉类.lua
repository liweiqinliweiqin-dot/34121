
local 命魂之玉类 = class()

-- local 寻物任务数据 = {"装备", "三药", "仙露小丸子"}
-- local 装备数据 = {"武器","头盔","发钗","项链","女衣","男衣","腰带","鞋子"}

local 寻物任务数据 = {"装备", "三药", "仙露小丸子"}
  local 装备数据 = {"武器","头盔","发钗","项链","女衣","男衣","腰带","鞋子"}
local 寻人任务数据 = {"嗔念心魔","贪念心魔","痴念心魔", "风起云涌"}
local 战斗任务数据 = {"顽石挡路"}
local 女娲祝福={"金香玉","风水混元丹","定神香","蛇蝎美人","千年保心丹","小还丹","五龙丹"}
local 女娲灵契={"野兽之力","放下屠刀","碎甲术","水清诀","碎甲术","圣灵之甲","冰清诀","晶清诀","命疗术"}
function 命魂之玉类:初始化()
    self.上古玉魄·阴={"伤害","速度","物理暴击等级","法术伤害","法术暴击等级","治疗能力","固定暴击等级","封印命中等级","狂暴等级","法术伤害结果","穿刺等级"}
    self.上古玉魄·阳={"气血","防御","法术防御","抗物理暴击等级","抗法术暴击等级","抗固定暴击等级","抵抗封印等级","格挡值","气血回复效果"}
    self.奇袭类型={"奇袭法术","法伤化劲","物伤化劲","固伤化劲","坚固无痕","坚如磐石"}
    self.属性类型={"抵抗封印等级","抗法术暴击等级","气血回复效果","抗物理暴击等级"}
    self.基础属性类型={
     抵抗封印等级={1.5,0.5},
     抗法术暴击等级={0.5,0.15},
     抗物理暴击等级={0.5,0.15},
     气血回复效果={5,1.5},
}
    self.灵尘等级属性={
   [2]="奇袭法术+0.5",
   [4]="开光孔+1",
   [6]="奇袭法术+0.5",
   [8]="奇袭法术+1",
   [10]="开光孔+1",
   [12]="奇袭法术+1",
   [14]="奇袭法术+1",
   [15]="奇袭法术+1",
}

    self.奇袭属性={
    奇袭法术={10,40},
    法伤化劲={10,40},
    物伤化劲={10,40},
    固伤化劲={10,40},
    坚固无痕={10,40},
    坚如磐石={10,40},
   }
    self.基础属性={
	伤害={6,16,3,10,6},
	速度={6,12,3,8,4.5},
	物理暴击等级={6,16,3,10,6},
	法术伤害={6,16,3,10,6},
	法术暴击等级={6,16,3,10,6},
	治疗能力={6,12,3,8,4.5},
	固定暴击等级={6,16,3,10,6},
	封印命中等级={6,16,3,10,6},
	狂暴等级={6,12,3,8,4.5},
	法术伤害结果={6,12,3,8,4.5},
	穿刺等级={6,16,3,10,6},
	气血={56,112,35,70,42},
	防御={16,32,10,20,12},
	法术防御={16,32,10,20,12},
	抗物理暴击等级={16,32,10,20,12},
	抗法术暴击等级={16,32,10,20,12},
	抗固定暴击等级={16,32,10,20,12},
	抵抗封印等级={16,32,10,20,12},
	格挡值={16,32,10,20,12},
	气血回复效果={8,16,5,10,6},


}

end

function 命魂之玉类:数据处理(id,序号,数字id,数据)
          if 序号==7501 then
                   self:获取命魂任务数据(数字id)
                   elseif 序号==7502 then
                   self:获取奖励1(数字id)
                   elseif 序号==7503 then
                   self:获取奖励2(数字id)
                   elseif 序号==7504 then
                   self:获取奖励3(数字id)
                    elseif 序号==7505 then
                   self:获取奖励4(数字id)
                    elseif 序号==7506 then
                   self:上古玉魄镶嵌(id,序号,数字id,数据)

                   elseif 序号==7507 then
                  道具刷新(数字id)
                  玩家数据[数字id].选择格子=tonumber(数据.编号)
                  发送数据(玩家数据[数字id].连接id,523,{等级=0,名称=数据.类型,道具=玩家数据[数字id].道具:索要道具1(数字id)})

                  elseif 序号==7508 then
                   self:玉魄镶嵌(id,序号,数字id,数据)





          end
end

function 命魂之玉类:玉魄镶嵌(id,序号,数字id,数据)

	 if 数据.序列2 then
      local 道具id1=tonumber(数据.序列2)
      local 道具id  = 玩家数据[数字id].角色.数据.道具[道具id1]
      if  not 道具id  then return end
      if  玩家数据[数字id].道具.数据[道具id]==nil or 玩家数据[数字id].道具.数据[道具id]==0 then return end


      if 玩家数据[数字id].最后镶嵌=="女娲祝福" and 玩家数据[数字id].道具.数据[道具id].名称=="女娲祝福" then

           local 玉的id=玩家数据[数字id].玉的id
           local 孔的编号=玩家数据[数字id].选择格子

           if 玩家数据[数字id].道具.数据[玉的id] then
           	    if 玩家数据[数字id].道具.数据[玉的id].奇袭类型.类型=="奇袭道具" then
           	    	 if 玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].开启 and 玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].参数=="空" then
           	    	     玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].参数=玩家数据[数字id].道具.数据[道具id].参数
           	    	     玩家数据[数字id].角色.数据.道具[道具id1]=nil
           	    	     玩家数据[数字id].道具.数据[道具id]=nil
           	    	     道具刷新(数字id)
						        发送数据(玩家数据[数字id].连接id,524,玩家数据[数字id].道具.数据[玉的id])

           	    	     常规提示(数字id,"镶嵌成功!")
           	    	 end

           	    end

           end



      elseif 玩家数据[数字id].最后镶嵌=="女娲灵契" and 玩家数据[数字id].道具.数据[道具id].名称=="女娲灵契" then

      	   local 玉的id=玩家数据[数字id].玉的id
           local 孔的编号=玩家数据[数字id].选择格子

           if 玩家数据[数字id].道具.数据[玉的id] then
           	    if 玩家数据[数字id].道具.数据[玉的id].奇袭类型.类型=="奇袭特技" then
           	    	 if 玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].开启 and 玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].参数=="空" then
           	    	     玩家数据[数字id].道具.数据[玉的id].奇袭类型.开孔[孔的编号].参数=玩家数据[数字id].道具.数据[道具id].参数
           	    	      玩家数据[数字id].角色.数据.道具[道具id1]=nil
           	    	      玩家数据[数字id].道具.数据[道具id]=nil
           	    	      发送数据(玩家数据[数字id].连接id,524,玩家数据[数字id].道具.数据[玉的id])
           	    	      道具刷新(数字id)

           	    	      常规提示(数字id,"镶嵌成功!")
           	    	 end

           	    end

           end


      else
         常规提示(玩家ID,"作弊封号处理!")--可以加封号逻辑b（￣▽￣）d　
      end
  end

end
function 命魂之玉类:上古玉魄镶嵌(id,序号,数字id,数据)
  if 数据.类型~="道具" then
  	常规提示(数字id,"在道具栏使用!")
      return
  end
  local 格子=tonumber(数据.装备)
  local 类型=数据.类型
  local 道具格子=玩家数据[数字id].角色.数据[类型][格子]
  local 道具=玩家数据[数字id].道具.数据[道具格子]
  if 道具.名称=="上古玉魄·阴" then
  	    玩家数据[数字id].最后镶嵌="女娲祝福"
  	    玩家数据[数字id].玉的id=道具格子

        发送数据(玩家数据[数字id].连接id,522,道具)
  elseif 道具.名称=="上古玉魄·阳" then
  	    玩家数据[数字id].最后镶嵌="女娲灵契"
        玩家数据[数字id].玉的id=道具格子
        发送数据(玩家数据[数字id].连接id,522,道具)
  else
      ---

  end


end
function 命魂之玉类:开启命魂之玉(玩家ID)
    local 任务类型 = {"寻人任务", "寻物任务", "战斗任务"}
  local 地图 = {
    1501,1193,1040,1208,1506,1110,1153,1168,1150,
    1140,1141,1122,1123,1514,1174,1091,1135,1173,
    1508,1001,1044,1512,1070,1111,1226,1122,1142
}
     if 玩家数据[玩家ID].角色.数据.命魂之玉==nil then
     	玩家数据[玩家ID].角色.数据.命魂之玉={}
     	玩家数据[玩家ID].角色.数据.命魂之玉.属性={}
     	玩家数据[玩家ID].角色.数据.命魂之玉.道具={}
     	local lx = self.属性类型[取随机数(1,#self.属性类型)]
        玩家数据[玩家ID].角色.数据.命魂之玉.属性.类型=lx
        玩家数据[玩家ID].角色.数据.命魂之玉.属性.数值=self.基础属性类型[lx][1]
        玩家数据[玩家ID].角色.数据.命魂之玉.属性.等级=0
        玩家数据[玩家ID].角色.数据.命魂之玉.属性.上限=15
     end
    if 命魂之玉数据[玩家ID] == nil then
        命魂之玉数据[玩家ID] = {
            铸魂进度 = 0,
            奖励领取 = {false,false,false,false},
            任务 = {},
            阶段 = 1,
            完成数量 = 0,
        }


        for i = 1, 60 do

            local 地图ID = 地图[取随机数(1, #地图)]
            local NPC数据 = 地图处理类:取NPC数据(地图ID)
            local NPC信息
            if NPC数据[1]==nil  then
                NPC信息 = NPC数据
            else
            	local NPC编号 = 取随机数(1, #NPC数据)
            	NPC信息 = NPC数据[NPC编号]

            end


            local 任务 = {
                地图 = 地图ID,
                名称 = NPC信息.名称,
                NPC编号 = NPC信息.编号,
                x = NPC信息.x,
                y = NPC信息.y,
                类型 = 任务类型[取随机数(1, 3)],
                完成=false
            }


            if 任务.类型 == "寻人任务" then
               任务.寻人类型=寻人任务数据[取随机数(1,#寻人任务数据)]

            elseif 任务.类型 == "寻物任务" then


                任务.需要物品 = {}
                local 物品类型 = 寻物任务数据[取随机数(1, #寻物任务数据)]
                任务.需要物品.类型 = 物品类型


                if 物品类型 == "装备" then
                    任务.需要物品.等级 = 取随机数(6, 8) * 10
                    任务.需要物品.名称 = 装备数据[取随机数(1, #装备数据)]
                    任务.需要物品.需要数量 = 4
                elseif 物品类型 == "三药" then
                    任务.需要物品.等级 = 3
                    任务.需要物品.名称 = "三级药"
                    任务.需要物品.需要数量 = 1
                elseif 物品类型 == "仙露小丸子" then
                    任务.需要物品.名称 = "仙露小丸子"
                    任务.需要物品.需要数量 = 15
                end

                任务.需要物品.已上交 = 0


            elseif 任务.类型 == "战斗任务" then
               任务.战斗任务=战斗任务数据[取随机数(1,#战斗任务数据)]
            end

            命魂之玉数据[玩家ID].任务[i] = 任务

        end
    end
    self:获取命魂任务数据(玩家ID)

end



function 命魂之玉类:完成战斗任务(玩家ID)



      if 玩家数据[玩家ID].铸魂任务 and 命魂之玉数据[玩家ID] then

         if not 命魂之玉数据[玩家ID].任务[玩家数据[玩家ID].铸魂任务.任务编号].完成 then
      	   self:完成任务(玩家ID,玩家数据[玩家ID].铸魂任务.任务编号)
      	   添加最后对话(玩家ID,"#Y/最近三界之中风云变幻，异动频频。我放心不下，想来确认一下你的安危。")
           常规提示(玩家ID,"#恭喜少侠获得了1点铸魂积分!")
        	end

      end

end
function 命魂之玉类:获取奖励1(玩家ID,任务编号)
       if  命魂之玉数据[玩家ID].奖励领取[1]  then
         常规提示(玩家ID,"你已经领取过该奖励!")
        elseif  命魂之玉数据[玩家ID].完成数量<15  then
         常规提示(玩家ID,"完成该阶段所有任务后可领取奖励")
       else
           玩家数据[玩家ID].道具:给予道具(玩家ID,"五色灵尘")
        	命魂之玉数据[玩家ID].奖励领取[1]=true
       end

end
function 命魂之玉类:获取奖励2(玩家ID,任务编号)
	if  命魂之玉数据[玩家ID].奖励领取[2]  then
         常规提示(玩家ID,"你已经领取过该奖励!")
       elseif  命魂之玉数据[玩家ID].完成数量<30  then
          常规提示(玩家ID,"完成该阶段所有任务后可领取奖励")
        else
      	命魂之玉数据[玩家ID].奖励领取[2]=true
      玩家数据[玩家ID].道具:给予道具(玩家ID,"女娲祝福")
        end

end
function 命魂之玉类:获取奖励3(玩家ID,任务编号)
	if  命魂之玉数据[玩家ID].奖励领取[3]  then
         常规提示(玩家ID,"你已经领取过该奖励!")
         elseif  命魂之玉数据[玩家ID].完成数量<45  then
          常规提示(玩家ID,"完成该阶段所有任务后可领取奖励")
        else
      	命魂之玉数据[玩家ID].奖励领取[3]=true
       玩家数据[玩家ID].道具:给予道具(玩家ID,"女娲灵契")
        end

end
function 命魂之玉类:获取奖励4(玩家ID,任务编号)

    
      if  命魂之玉数据[玩家ID].奖励领取[4]  then
         常规提示(玩家ID,"你已经领取过该奖励!")
        elseif  命魂之玉数据[玩家ID].完成数量<60  then
         常规提示(玩家ID,"完成该阶段所有任务后可领取奖励")
         elseif  not 命魂之玉数据[玩家ID].奖励领取[1]  then
         常规提示(玩家ID,"第一阶段的奖励你还没领取！")
         elseif  not 命魂之玉数据[玩家ID].奖励领取[2]  then
         常规提示(玩家ID,"第二阶段的奖励你还没领取！")
         elseif  not 命魂之玉数据[玩家ID].奖励领取[3]  then
         常规提示(玩家ID,"第三阶段的奖励你还没领取！")
         elseif  not 命魂之玉数据[玩家ID].奖励领取[4]  then
         常规提示(玩家ID,"第四阶段的奖励你还没领取！")
       else



   local 临时格子=玩家数据[玩家ID].角色:取道具格子()
     if 临时格子==0 then
    常规提示(玩家ID,7,"#Y/该玩家没有足够的空间存放物品")
    return
  end
   local 奇袭类型="奇袭道具"
   local 名称="上古玉魄·阴"
   if 取随机数()<=50 then
      名称="上古玉魄·阳"
      奇袭类型="奇袭特技"
   end


    local 道具 = {}
    道具.名称=名称
    道具.灵尘等级=0
    道具.灵尘附加等级=0
    道具.耐久度=300
    local 主类型=self[名称][取随机数(1,#self[名称])]
    local 数值=取随机数(self.基础属性[主类型][1],self.基础属性[主类型][2])
    道具.基础属性={类型=主类型,数值=数值}
    道具.附加属性={}
    local 类型1=self[名称][取随机数(1,#self[名称])]
    local 数值=取随机数(self.基础属性[类型1][3],self.基础属性[类型1][4])
    道具.附加属性[1]={类型=类型1,数值=数值}
    道具.附加属性[1].灵尘=0
    local 类型2=self[名称][取随机数(1,#self[名称])]
    local 数值=取随机数(self.基础属性[类型2][3],self.基础属性[类型2][4])
    道具.附加属性[2]={类型=类型2,数值=数值}
    道具.附加属性[2].灵尘=0
    local 类型=self.奇袭类型[取随机数(1,#self.奇袭类型)]
    if 取随机数(1,10)==1 then
       道具.奇袭蓝字={}
       道具.奇袭蓝字.类型=类型
       道具.奇袭蓝字.数值=取随机数(10,40)/10

    end
    if 主类型==类型1 then
    道具.灵尘附加等级=道具.灵尘附加等级+1
    道具.附加属性[1].灵尘= 道具.附加属性[1].灵尘+self.基础属性[道具.附加属性[1].类型][5]
    道具.附加属性[2].灵尘= 道具.附加属性[2].灵尘+self.基础属性[道具.附加属性[2].类型][5]
    end
    if 主类型==类型2 then
    道具.灵尘附加等级=道具.灵尘附加等级+1
    道具.附加属性[1].灵尘= 道具.附加属性[1].灵尘+self.基础属性[道具.附加属性[1].类型][5]
    道具.附加属性[2].灵尘= 道具.附加属性[2].灵尘+self.基础属性[道具.附加属性[2].类型][5]
    end
    道具.识别码=取唯一识别码(玩家ID)
    道具.奇袭类型={}
    道具.奇袭类型.类型=奇袭类型
    道具.奇袭类型.开孔={}
    道具.奇袭类型.开孔[1]={开启=true,参数="空"}
    道具.奇袭类型.开孔[2]={开启=false}
    道具.奇袭类型.开孔[3]={开启=false}
    道具.总类="qq1809610993"
    local 格子=玩家数据[玩家ID].道具:取新编号()
    玩家数据[玩家ID].道具.数据[格子]=道具
    玩家数据[玩家ID].角色.数据.道具[临时格子]=格子
    常规提示(玩家ID,"#Y/你得到了#R/"..名称)
    道具刷新(玩家ID)




     	命魂之玉数据[玩家ID].奖励领取[4]=true
       end






end

function 命魂之玉类:刷新属性(id)

   local  命魂之玉=玩家数据[id].角色.数据.命魂之玉

          玩家数据[id].角色.数据.命魂之玉.战斗属性={}
          玩家数据[id].角色.数据.命魂之玉.奇袭道具={}
          玩家数据[id].角色.数据.命魂之玉.奇袭特技={}
     for i=1,2 do
     	    if 命魂之玉.道具[i] and 命魂之玉.道具[i].道具  then
     	    	   if 玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.基础属性.类型]==nil then
     	           玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.基础属性.类型]=命魂之玉.道具[i].道具.基础属性.数值
     	           else
                   玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.基础属性.类型]=玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.基础属性.类型]+命魂之玉.道具[i].道具.基础属性.数值
     	           end

                  for o=1,2 do
                     if 玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.附加属性[o].类型]==nil then
                 	    玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.附加属性[o].类型]=命魂之玉.道具[i].道具.附加属性[o].数值+命魂之玉.道具[i].道具.附加属性[o].灵尘
                 	else
                 		玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.附加属性[o].类型]=玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.附加属性[o].类型]+命魂之玉.道具[i].道具.附加属性[o].数值+命魂之玉.道具[i].道具.附加属性[o].灵尘

                     end
                 end

                 if  命魂之玉.道具[i].道具.奇袭蓝字  then
                     if  玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.奇袭蓝字.类型]==nil then
                     	 玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.奇袭蓝字.类型]=命魂之玉.道具[i].道具.奇袭蓝字.数值
                     	else
                     		玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.奇袭蓝字.类型]=玩家数据[id].角色.数据.命魂之玉.战斗属性[命魂之玉.道具[i].道具.奇袭蓝字.类型]+命魂之玉.道具[i].道具.奇袭蓝字.数值

                     end
                 end


                 for o=1,3 do

                 	if 命魂之玉.道具[i].道具.奇袭类型.开孔[o].开启 and 命魂之玉.道具[i].道具.奇袭类型.开孔[o].参数 and 命魂之玉.道具[i].道具.奇袭类型.开孔[o].参数~="空" then

                 		local 长度=#玩家数据[id].角色.数据.命魂之玉[命魂之玉.道具[i].道具.奇袭类型.类型]

                 		玩家数据[id].角色.数据.命魂之玉[命魂之玉.道具[i].道具.奇袭类型.类型][长度+1]=DeepCopy(命魂之玉.道具[i].道具.奇袭类型.开孔[o])

                 	end

                 end

                  if 命魂之玉.道具[i].道具.奇袭法术  then
                  	   if 玩家数据[id].角色.数据.命魂之玉.战斗属性.奇袭法术==nil then
                  	  	玩家数据[id].角色.数据.命魂之玉.战斗属性.奇袭法术=命魂之玉.道具[i].道具.奇袭法术
                  	   else
                       玩家数据[id].角色.数据.命魂之玉.战斗属性.奇袭法术=玩家数据[id].角色.数据.命魂之玉.战斗属性.奇袭法术+命魂之玉.道具[i].道具.奇袭法术
                  	   end


                  end




     	    end



end



end

function 命魂之玉类:完成任务(玩家ID,任务编号)

       命魂之玉数据[玩家ID].任务[任务编号].完成=true
       命魂之玉数据[玩家ID].完成数量=命魂之玉数据[玩家ID].完成数量+1

       if 命魂之玉数据[玩家ID].完成数量==15 then
       	 命魂之玉数据[玩家ID].阶段=2
       elseif 命魂之玉数据[玩家ID].完成数量==30 then
       	 命魂之玉数据[玩家ID].阶段=3
       	    elseif 命魂之玉数据[玩家ID].完成数量==45 then
       	 命魂之玉数据[玩家ID].阶段=4
       end


        if 命魂之玉数据[玩家ID] then

            发送数据(玩家数据[玩家ID].连接id,521,命魂之玉数据[玩家ID])
        else
        	常规提示(id,"你还未开启命魂任务哦。")

        end
end

function 命魂之玉类:获取命魂任务数据(玩家ID)
	 if 玩家数据[玩家ID].角色.数据.命魂之玉 then
	 	发送数据(玩家数据[玩家ID].连接id,525,玩家数据[玩家ID].角色.数据.命魂之玉 )
	 end
    -- 修复table is nil错误：添加对命魂之玉数据[玩家ID]的nil检查
    if 命魂之玉数据[玩家ID] then
        table.print(命魂之玉数据[玩家ID] )
        
        发送数据(玩家数据[玩家ID].连接id,520,命魂之玉数据[玩家ID])
    else
    	常规提示(玩家ID,"你还未开启命魂任务哦。")
    
    end

end

return 命魂之玉类
