--======================================================================--
-- @作者: GGE研究群: 342119466
-- @创建时间:   2018-03-03 02:34:19
-- @Last Modified time: 2025-09-26 17:26:33
-- 梦幻西游游戏资源破解 baidwwy@vip.qq.com(313738139) 老毕   和 C++PrimerPlus 717535046 这俩位大神破解所以资源
--======================================================================--
local Dismay = class()

function Dismay:初始化(id,内容)
    强化数据= 取csv数据("sql/强化数据.csv")
    -- print("强化数据")
    -- table.print(强化数据)
end
function Dismay:数据处理(id,内容)
    if 内容.事件=="升星" then
   	  self:升星处理(id,内容)
   end
end

function Dismay:升星处理(id,内容)
    if 内容.事项=="装备进阶打开" then
      -- print("获取装备数据")
      -- table.print(玩家数据[id].角色:取装备数据())
    	发送数据(玩家数据[id].连接id,394,玩家数据[id].角色:取装备数据())
    elseif 内容.事项=="灵饰进阶打开" then
      发送数据(玩家数据[id].连接id,394.1,玩家数据[id].角色:取灵饰数据())
    elseif  内容.事项=="装备升星" then
    	local 编号=内容.编号

      if 玩家数据[id].角色.数据.装备[编号] and 玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]] then

      	local currentLevel = 玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星 or 0
      	local 等级 = math.max(0, currentLevel)
      	local  数据=强化数据[等级+1]
      	if  not 数据 then
      		return  常规提示(id,"当前已经是最高等级")
      	end

      	local 银子=数据.银子
      	local 经验=数据.经验
      	local 强化材料=分割文本(数据.强化消耗,"*")[1]
      	local 强化数量=分割文本(数据.强化消耗,"*")[2]+0
      	local 保护材料=分割文本(数据.保护,"*")[1]
      	local 保护数量=分割文本(数据.保护,"*")[2]+0
      	local 成功几率=数据.强化几率+0
      	if 玩家数据[id].角色.数据.银子<银子 then

               	  常规提示(id, "银子不足")
      		return
      	end
      	if 玩家数据[id].角色.数据.当前经验<经验 then
               	  常规提示(id, "经验不足")
      		return
      	end
      	if  not  玩家数据[id].道具:消耗背包道具(id,强化材料,强化数量)  then

               	  常规提示(id, 强化材料.."不足"..强化数量.."个")
      		return
      	end
      	玩家数据[id].角色:扣除银子(银子,0,0,"强化",1)
      	玩家数据[id].角色:扣除经验(经验)
      	local 保护=内容.保护
      	if  保护 and 玩家数据[id].道具:消耗背包道具(id,保护材料,保护数量) then
      	  保护=true
      	else
      	   保护=false
      	end
      	if  取随机数()<成功几率 then

      	    玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星=(玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星 or 0)+1


      	     玩家数据[id].角色:刷新信息()
      	     发送数据(玩家数据[id].连接id,394,{成功=2})
      	     发送数据(玩家数据[id].连接id,394,玩家数据[id].角色:取装备数据())
      	 else
      	   if  保护 then
               	  常规提示(id, "强化失败,保护不降级")
           else
               	 if  玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星 and 玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星>0 then

               	     玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星= 玩家数据[id].道具.数据[玩家数据[id].角色.数据.装备[编号]].升星-1
                     function 消息提示(目标id, 内容)
                         -- 基础实现：打印到控制台
                       -- print("给ID为"..tostring(目标id).."的提示："..内容)
                        end
               	     消息提示(id, "强化失败,等级-1")
               	       玩家数据[id].角色:刷新信息()

               	      发送数据(玩家数据[id].连接id,394,玩家数据[id].角色:取装备数据())
               	  end
               	   发送数据(玩家数据[id].连接id,394,{成功=1})


      	   end

      	end
      else
      	常规提示(id,"未找到指定装备,请重新打开界面尝试")
      end
    elseif  内容.事项=="灵饰升星" then
      local 编号=内容.编号
      local 道具id =玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]]
      local wpfl = 道具id.分类
      local wpzl = 道具id.总类
      if wpfl == 13 and 道具id.体质== nil then--手镯
        道具id.体质=1
      elseif wpfl == 10 and 道具id.敏捷== nil then--耳饰
        道具id.敏捷=1
      elseif wpfl == 11 and 道具id.耐力== nil then--耳饰
        道具id.耐力=1
      elseif wpfl == 12 and 道具id.力量== nil and 道具id.魔力==nil then--耳饰
        道具id.力量=1
        道具id.魔力=1
      end

      if  玩家数据[id].角色.数据.灵饰[编号] and   玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]] then
        -- 确保升星等级正确初始化，避免搬运数据后出现的问题
        local currentLevel = 玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星 or 0
        local 等级 = math.max(0, currentLevel)  -- 确保等级不小于0
        local  数据=强化数据[等级+1]
        if  not 数据 then
          return  常规提示(id,"当前已经是最搞等级")
        end
        local 银子=数据.银子
        local 经验=数据.经验
        local 强化材料=分割文本(数据.强化消耗,"*")[1]
        local 强化数量=分割文本(数据.强化消耗,"*")[2]+0
        local 保护材料=分割文本(数据.保护,"*")[1]
        local 保护数量=分割文本(数据.保护,"*")[2]+0
        local 成功几率=数据.强化几率+0
        if 玩家数据[id].角色.数据.银子<银子 then
                  常规提示(id, "银子不足")
          return
        end
        if 玩家数据[id].角色.数据.当前经验<经验 then
                  常规提示(id, "经验不足")
          return
        end
        if  not  玩家数据[id].道具:消耗背包道具(id,强化材料,强化数量)  then

                  常规提示(id, 强化材料.."不足"..强化数量.."个")
          return
        end
        玩家数据[id].角色:扣除银子(银子,0,0,"强化",1)
        玩家数据[id].角色:扣除经验(经验)
        local 保护=内容.保护
        if  保护 and 玩家数据[id].道具:消耗背包道具(id,保护材料,保护数量) then
          保护=true
        else
           保护=false
        end
        if  取随机数()<成功几率 then
            玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星=(玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星 or 0)+1
             玩家数据[id].角色:刷新信息()
             发送数据(玩家数据[id].连接id,394.1,{成功=2})
             发送数据(玩家数据[id].连接id,394.1,玩家数据[id].角色:取灵饰数据())
         else
           if  保护 then
              常规提示(id, "强化失败,保护不降级")
           else
                 if 玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星 and 玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星>0 then
                    玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星 = 玩家数据[id].道具.数据[玩家数据[id].角色.数据.灵饰[编号]].升星-1
                    消息提示(id, "强化失败,等级-1")
                    玩家数据[id].角色:刷新信息()
                    发送数据(玩家数据[id].连接id,394.1,玩家数据[id].角色:取灵饰数据())
                  end
                   发送数据(玩家数据[id].连接id,394.1,{成功=1})


           end

        end
      else
        常规提示(id,"未找到指定装备,请重新打开界面尝试")
      end


    end
end


return Dismay