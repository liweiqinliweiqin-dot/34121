local 仙玉商城类 = class()

function 仙玉商城类:初始化(文件)
    -- 初始化商城数据
    self:刷新商城商品()
end

-- 刷新商城商品配置（核心：加载所有神兽分类）
function 仙玉商城类:刷新商城商品()
    仙玉商城 = {
        银子商城 = {杂货商品={},锻造商品={},宝石商品={},孩子商品={}},
        仙玉商城 = {仙玉商品={},锻造商品={},宝宝商品={},孩子商品={},法宝商品={},灵宝商品={}},
        锦衣商城 = {锦衣商品={},祥瑞商品={},足迹商品={},足印商品={},战锦商品={}},
        神兽商城 = {商品详情={},一代神兽={},二代神兽={},三代神兽={},四代神兽={}}, -- 完整神兽分类
        积分商城 = {妖魔积分={},活跃积分={},镇妖积分={},师门积分={},成就积分={},副本积分={}},
        点卡商城 = {商品详情={}},
        冒泡框 = {商品详情={}}
    }
    -- 加载仙玉商城配置文件
    local 代码函数 = loadstring(读入文件([[仙玉商城.txt]]))
    if 代码函数 then
        代码函数()
    else
        print("仙玉商城配置文件加载失败！")
    end
end

-- 核心购买逻辑（修复神兽购买限制）
function 仙玉商城类:仙玉商城购买(id,类型,序号,数量,大分类)
    -- 基础校验：商品是否存在、玩家数据是否有效
    if not 仙玉商城[大分类] or not 仙玉商城[大分类][类型] or not 仙玉商城[大分类][类型][序号] then
        常规提示(id,"#Y该商品不存在！")
        return
    end
    if not 玩家数据[id] or not 共享货币[玩家数据[id].账号] then
        常规提示(id,"#Y玩家数据异常！")
        return
    end

    -- 获取商品信息
    local 商品信息 = 仙玉商城[大分类][类型][序号]
    local 名称 = 商品信息[1]
    local 仙玉价格 = 商品信息[4] or 0
    local 购买数量 = 数量 or 1
    local 总需求仙玉 = 购买数量 * 仙玉价格

    -- 校验购买数量
    if 购买数量 <= 0 then
        常规提示(id,"#Y购买数量必须大于0！")
        return
    end

    -- ========== 神兽商城专属购买逻辑（核心修复） ==========
    if 大分类 == "神兽商城" then
        -- 1. 校验仙玉是否充足
        if 共享货币[玩家数据[id].账号].仙玉 < 总需求仙玉 then
            常规提示(id,"#Y你的仙玉不足，无法购买该神兽！")
            return
        end
        -- 2. 校验背包空位（神兽需要至少1个空位）
        local 背包空位 = 玩家数据[id].道具:取空位数量()
        if 背包空位 < 1 then
            常规提示(id,"#Y你的背包已满，请清理后再购买！")
            return
        end
        -- 3. 扣除仙玉（强制生效）
        local 扣除成功 = 共享货币[玩家数据[id].账号]:扣除仙玉(总需求仙玉,"购买神兽："..名称,id)
        if not 扣除成功 then
            常规提示(id,"#Y仙玉扣除失败，请联系管理员！")
            return
        end
        -- 4. 交付神兽（跳过所有通用限制）
        self:仙玉商城商品处理(id,名称,购买数量)
        常规提示(id,format("#Y恭喜你！成功花费#R%s#Y点仙玉购买神兽#R%s",总需求仙玉,名称))
        -- 5. 刷新商城显示
        self:取仙玉商城商品(id,类型,92.2,大分类)
        return -- 直接结束流程，避免触发通用逻辑的限制
    end

    -- ========== 其他分类通用购买逻辑（保留原有功能） ==========
    if 大分类 == "银子商城" then
        -- 银子购买逻辑
        if 玩家数据[id].角色.数据.银子 < 总需求仙玉 then
            常规提示(id,"#Y你的银子不足！")
            return
        end
        玩家数据[id].角色:扣除银子(总需求仙玉,"商城购买："..名称,1)
        self:仙玉商城商品处理(id,名称,购买数量)
        常规提示(id,format("#Y花费#R%s#Y两银子购买了#R%s",总需求仙玉,名称))
    elseif 大分类 == "积分商城" then
        -- 积分购买逻辑
        local 积分类型 = 类型
        local 玩家积分 = 玩家数据[id].角色.数据[积分类型] or 0
        if 玩家积分 < 总需求仙玉 then
            常规提示(id,"#Y你的"..积分类型.."不足！")
            return
        end
        玩家数据[id].角色.数据[积分类型] = 玩家积分 - 总需求仙玉
        self:仙玉商城商品处理(id,名称,购买数量)
        常规提示(id,format("#Y花费#R%s#Y"..积分类型.."购买了#R%s",总需求仙玉,名称))
    elseif 大分类 == "点卡商城" then
        -- 点卡购买逻辑
        if not 共享货币[玩家数据[id].账号]:扣除点卡(总需求仙玉,id,"商城购买") then
            常规提示(id,"#Y你的点卡不足！")
            return
        end
        self:仙玉商城商品处理(id,名称,购买数量)
        常规提示(id,format("#Y花费#R%s#Y点卡购买了#R%s",总需求仙玉,名称))
    else
        -- 仙玉/锦衣等其他分类
        if not 共享货币[玩家数据[id].账号]:扣除仙玉(总需求仙玉,"商城购买："..名称,id) then
            常规提示(id,"#Y你的仙玉不足！")
            return
        end
        self:仙玉商城商品处理(id,名称,购买数量)
        常规提示(id,format("#Y花费#R%s#Y点仙玉购买了#R%s",总需求仙玉,名称))
    end

    -- 刷新商城显示
    self:取仙玉商城商品(id,类型,92.2,大分类)
end

-- 商品交付处理（兼容神兽）
function 仙玉商城类:仙玉商城商品处理(id,名称,数量)
    -- 优先处理神兽交付
    local 是神兽 = false
    -- 遍历所有神兽分类校验
    for 分类键,分类数据 in pairs(仙玉商城.神兽商城 or {}) do
        for 序号,商品信息 in pairs(分类数据 or {}) do
            if 商品信息[1] == 名称 then
                是神兽 = true
                break
            end
        end
        if 是神兽 then break end
    end
    -- 神兽直接交付
    if 是神兽 then
        for i=1,数量 do
            玩家数据[id].道具:给予神兽(id,名称)
        end
        return
    end

    -- 其他商品通用交付逻辑（保留原有功能）
    local 物品 = 取物品数据(名称)
    if not 物品 then
        常规提示(id,"#Y物品数据异常："..名称)
        return
    end

    -- 法宝/灵宝/锦衣等特殊物品处理
    if 物品[2] == 1000 then
        for i=1,数量 do
            玩家数据[id].道具:给予法宝(id,名称)
        end
    elseif 物品[2] == 1005 then
        for i=1,数量 do
            玩家数据[id].道具:给予灵宝(id,名称)
        end
    elseif 物品[2] == 778 then
        for i=1,数量 do
            玩家数据[id].角色:给予坐骑(id,名称)
        end
    elseif 物品[2] == 2 and 物品[5] == 60 then
        for i=1,数量 do
            玩家数据[id].道具:给予锦衣(id,名称)
        end
    else
        -- 普通道具交付
        玩家数据[id].道具:给予道具(id,名称,数量)
    end
end

-- 获取商城商品列表（刷新显示）
function 仙玉商城类:取仙玉商城商品(id,类型,序号,大分类)
    if not 仙玉商城[大分类] or not 仙玉商城[大分类][类型] then
        常规提示(id,"#Y商品分类异常！")
        return
    end

    local 发送信息 = {
        商品 = 仙玉商城[大分类][类型],
        神兽介绍 = {},
        仙玉 = 玩家数据[id].仙玉 or 0,
        银子 = 玩家数据[id].角色.数据.银子 or 0,
        点卡 = 玩家数据[id].点卡 or 0,
        活跃积分 = 玩家数据[id].角色.数据.活跃积分 or 0,
        妖魔积分 = 玩家数据[id].角色.数据.妖魔积分 or 0,
        镇妖积分 = 玩家数据[id].角色.数据.镇妖积分 or 0,
        师门积分 = 玩家数据[id].角色.数据.师门积分 or 0,
        成就积分 = 玩家数据[id].角色.数据.成就积分 or 0,
        副本积分 = 玩家数据[id].角色.数据.副本积分 or 0,
        分类 = 类型,
        大分类 = 大分类
    }

    -- 神兽详情补充（保留原有功能）
    if 大分类 == "神兽商城" then
        for i=1,#发送信息.商品 do
            发送信息.神兽介绍[i] = {}
            local 物理宝宝 = 取商城宝宝(发送信息.商品[i][1].."(物理型)") or {}
            local 法术宝宝 = 取商城宝宝(发送信息.商品[i][1].."(法术型)") or {}
            发送信息.神兽介绍[i].攻击资质 = 物理宝宝[2] or 0
            发送信息.神兽介绍[i].防御资质 = 物理宝宝[3] or 0
            发送信息.神兽介绍[i].体力资质 = 物理宝宝[4] or 0
            发送信息.神兽介绍[i].法力资质 = 物理宝宝[5] or 0
            发送信息.神兽介绍[i].速度资质 = 物理宝宝[6] or 0
            发送信息.神兽介绍[i].躲闪资质 = 物理宝宝[7] or 0
            发送信息.神兽介绍[i].成长 = 物理宝宝[8] or 0
            -- 技能拼接
            发送信息.神兽介绍[i].物理技能 = table.concat(物理宝宝[9] or {}, " ")
            发送信息.神兽介绍[i].物理天生 = table.concat(物理宝宝[11] or {}, " ")
            发送信息.神兽介绍[i].法术技能 = table.concat(法术宝宝[9] or {}, " ")
            发送信息.神兽介绍[i].法术天生 = table.concat(法术宝宝[11] or {}, " ")
        end
    end

    -- 发送商品数据给客户端
    发送数据(玩家数据[id].连接id,序号 or 91,发送信息)
    发送信息 = nil -- 释放内存
end

-- 对外暴露刷新函数
function 刷新商城商品()
    local 商城实例 = 仙玉商城类:new()
    商城实例:刷新商城商品()
end

return 仙玉商城类