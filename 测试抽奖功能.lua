-- 测试抽奖功能
function 测试抽奖功能()
  -- 模拟玩家数据
  玩家数据 = {}
  玩家数据["test_user"] = {角色={数据={抽奖幸运值=0}}}
  
  -- 模拟自定义数据
  自定义数据 = {}
  自定义数据.抽奖配置 = {
    {名称="普通奖励1", 概率=50},
    {名称="四代神兽自选礼包", 概率=1},
    {名称="高级装备自选礼包", 概率=2},
    {名称="超级点化石礼盒", 概率=3},
    {名称="神兽超级礼包", 概率=0.5}
  }
  
  print("开始测试抽奖功能...")
  
  -- 测试1: 普通抽奖（积分值为0）
  local 玩家id = "test_user"
  print("\n测试1: 普通抽奖（积分值为0）")
  local 中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
  end
  
  -- 测试2: 必给奖励（幸运值为3 - 四代神兽自选礼包）
  print("\n测试2: 必给奖励（幸运值为3 - 四代神兽自选礼包）")
  玩家数据[玩家id].角色.数据.抽奖幸运值 = 3
  中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
    print("是否获得四代神兽自选礼包:", 自定义数据.抽奖配置[中奖索引].名称 == "四代神兽自选礼包")
  end
  
  -- 测试3: 必给奖励（幸运值为6 - 高级装备自选礼包）
  print("\n测试3: 必给奖励（幸运值为6 - 高级装备自选礼包）")
  玩家数据[玩家id].角色.数据.抽奖幸运值 = 6
  中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
    print("是否获得高级装备自选礼包:", 自定义数据.抽奖配置[中奖索引].名称 == "高级装备自选礼包")
  end
  
  -- 测试4: 必给奖励（幸运值为10 - 超级点化石礼盒）
  print("\n测试4: 必给奖励（幸运值为10 - 超级点化石礼盒）")
  玩家数据[玩家id].角色.数据.抽奖幸运值 = 10
  中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
    print("是否获得超级点化石礼盒:", 自定义数据.抽奖配置[中奖索引].名称 == "超级点化石礼盒")
  end
  
  -- 测试5: 必给奖励（幸运值为19 - 神兽超级礼包）
  print("\n测试5: 必给奖励（幸运值为19 - 神兽超级礼包）")
  玩家数据[玩家id].角色.数据.抽奖幸运值 = 19
  中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
    print("是否获得神兽超级礼包:", 自定义数据.抽奖配置[中奖索引].名称 == "神兽超级礼包")
  end
  
  -- 测试6: 重置功能（积分值重置为0）
  print("\n测试6: 重置功能（积分值重置为0）")
  print("重置后幸运值:", 玩家数据[玩家id].角色.数据.抽奖幸运值)
  
  -- 测试7: 重置后的普通抽奖
  print("\n测试7: 重置后的普通抽奖")
  中奖索引 = 系统处理类:抽奖中奖(玩家id)
  print("中奖索引:", 中奖索引)
  if 中奖索引 and 自定义数据.抽奖配置[中奖索引] then
    print("中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
  end
  
  print("\n测试完成!")
end

-- 辅助函数
table.insert = table.insert or function(t, v)
    t[#t+1] = v
    return #t
end

function 删除重复(t)
    if not t then return t end
    local 临时表 = {}
    local 结果表 = {}
    for i, v in ipairs(t) do
        if not 临时表[tostring(v)] then
            临时表[tostring(v)] = true
            table.insert(结果表, v)
        end
    end
    return 结果表
end

function 取随机数(min, max)
    if min and max then
        return math.random(min, max)
    else
        return math.random(100)
    end
end

-- 初始化系统处理类
系统处理类 = {}
-- 这里需要复制修改后的抽奖中奖函数
系统处理类.抽奖中奖 = function(self, id)
  local 玩家抽奖幸运值 = 0
  if id and 玩家数据[id] and 玩家数据[id].角色.数据.抽奖幸运值 then
    玩家抽奖幸运值 = 玩家数据[id].角色.数据.抽奖幸运值
  end

  local 必给奖励次数和物品 = {
    {次数=3, 物品名称="四代神兽自选礼包"},
    {次数=6, 物品名称="高级装备自选礼包"},
    {次数=10, 物品名称="超级点化石礼盒"},
    {次数=19, 物品名称="神兽超级礼包"}
  }
  for _, v in ipairs(必给奖励次数和物品) do
    if 玩家抽奖幸运值 == v.次数 then
      if 自定义数据.抽奖配置 and #自定义数据.抽奖配置 > 0 then
        -- 查找指定物品的索引
        for i=1,#自定义数据.抽奖配置 do
          if 自定义数据.抽奖配置[i].名称 == v.物品名称 then
            return i
          end
        end
        -- 如果没找到指定物品，则返回第一个物品
        return 1
      end
    end
-- 检查是否需要重置幸运值
  if 玩家抽奖幸运值 >= 20 and 玩家数据[id] then
    玩家数据[id].角色.数据.抽奖幸运值 = 0
    print("幸运值已重置为0")
  end
  
  -- 原有抽奖逻辑
  local 中奖编号 = 0
  local 获得物品={}
  local 可以获得={}
  local 计算概率 ={}
  for i=1,#自定义数据.抽奖配置 do
    计算概率[i]={概率=自定义数据.抽奖配置[i].概率}
  end
  计算概率=删除重复(计算概率)
  table.sort(计算概率,  function(a,b) return a.概率>b.概率  end )
  local 获得概率 = 取随机数(1,计算概率[1].概率)
  for i=1,#自定义数据.抽奖配置 do
    if 自定义数据.抽奖配置[i].概率>0 and 获得概率<=自定义数据.抽奖配置[i].概率 then
      获得物品[#获得物品+1]={物品=自定义数据.抽奖配置[i],编号=i}
    end
    if 自定义数据.抽奖配置[i].概率>0 then
      可以获得[#可以获得+1] ={物品=自定义数据.抽奖配置[i],编号=i}
    end
  end
  获得物品=删除重复(获得物品)
  可以获得=删除重复(可以获得)
  if 获得物品~=nil then
    local 取编号=取随机数(1,#获得物品)
    if 获得物品[取编号]~=nil and 获得物品[取编号].物品~=nil and 获得物品[取编号].编号~=nil then
      中奖编号 = 获得物品[取编号].编号
    end
  end
  if  中奖编号==0 then
    local 可以编号=可以获得[取随机数(1,#可以获得)].编号
    return 可以编号
  else
    return 中奖编号
  end
end

-- 执行测试
测试抽奖功能()