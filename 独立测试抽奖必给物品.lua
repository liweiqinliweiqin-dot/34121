-- 独立测试抽奖必给物品功能
print("开始测试抽奖必给物品功能...")

-- 模拟系统处理类
local 系统处理类 = {}

-- 模拟自定义数据.抽奖配置
local 自定义数据 = {}
自定义数据.抽奖配置 = {
  {名称 = "四代神兽自选礼包", 类型 = 1, 描述 = "神兽礼包", 备注 = "测试", 概率 = 1},
  {名称 = "高级装备自选礼包", 类型 = 1, 描述 = "装备礼包", 备注 = "测试", 概率 = 1},
  {名称 = "超级点化石礼盒", 类型 = 1, 描述 = "点化石", 备注 = "测试", 概率 = 1},
  {名称 = "神兽超级礼包", 类型 = 1, 描述 = "超级礼包", 备注 = "测试", 概率 = 1},
  {名称 = "普通物品", 类型 = 1, 描述 = "普通", 备注 = "测试", 概率 = 100}
}

-- 模拟玩家数据
local 玩家数据 = {
  ["test_player"] = {
    角色 = {
      数据 = {
        抽奖幸运值 = 0
      }
    }
  }
}

-- 实现抽奖中奖函数（从系统处理类复制并修改）
function 系统处理类:抽奖中奖(id)
  local 玩家抽奖幸运值 = 0
  if id and 玩家数据[id] and 玩家数据[id].角色.数据.抽奖幸运值 then
    玩家抽奖幸运值 = 玩家数据[id].角色.数据.抽奖幸运值
  end

  -- 输出调试信息
  if id then
    print("抽奖ID:", id, "抽奖幸运值:", 玩家抽奖幸运值)
  end

  local 必给奖励次数和物品 = {
    {次数=3, 物品名称="四代神兽自选礼包"},
    {次数=6, 物品名称="高级装备自选礼包"},
    {次数=10, 物品名称="超级点化石礼盒"},
    {次数=19, 物品名称="神兽超级礼包"}
  }
  
  -- 遍历必给奖励列表
  for _, v in ipairs(必给奖励次数和物品) do
    if 玩家抽奖幸运值 == v.次数 then
      print("触发必给奖励! 次数:", v.次数, "物品名称:", v.物品名称)
      
      if 自定义数据.抽奖配置 and #自定义数据.抽奖配置 > 0 then
        -- 查找指定物品的索引
        local 找到物品 = false
        for i=1,#自定义数据.抽奖配置 do
          if 自定义数据.抽奖配置[i].名称 and 自定义数据.抽奖配置[i].名称 == v.物品名称 then
            print("找到指定物品，索引:", i, "物品名称:", 自定义数据.抽奖配置[i].名称)
            找到物品 = true
            return i
          end
        end
        
        -- 如果没找到指定物品，输出警告并返回第一个物品
        if not 找到物品 then
          print("警告: 未找到指定物品:", v.物品名称, "返回第一个物品")
          return 1
        end
      else
        print("警告: 自定义数据.抽奖配置不存在或为空")
      end
    end
  end
  
  -- 非必给情况的简单处理（返回普通物品）
  print("未触发必给奖励，返回普通物品")
  return 5
end

-- 测试不同幸运值的情况
local 测试幸运值列表 = {0, 1, 2, 3, 4, 5, 6, 9, 10, 18, 19, 20}

for _, 测试幸运值 in ipairs(测试幸运值列表) do
  print("\n=== 测试幸运值:", 测试幸运值, "===")
  -- 设置当前幸运值
  玩家数据["test_player"].角色.数据.抽奖幸运值 = 测试幸运值
  -- 调用抽奖函数
  local 中奖索引 = 系统处理类:抽奖中奖("test_player")
  print("最终中奖索引:", 中奖索引, "中奖物品:", 自定义数据.抽奖配置[中奖索引].名称)
end

print("\n测试完成！")